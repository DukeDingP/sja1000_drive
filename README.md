# sja1000_drive
drive can bus communication chip sja1000
2.1	Sja1000芯片内部功能图
图1  sja1000内部功能图
Fig.1 Figure1 of paper
2.1.1接口管理逻辑(IML)
解释来自CPU的命令，控制CAN寄存器的寻址，向主控制器提供中断信息和状态信息。
2.1.2 发送缓冲器 (TXB)
发送缓冲器是 CPU 和 BSP 位流处理器 之间的接口 能够存储发送到 CAN 网络上的完整信息缓
冲器长 13 个字节 由 CPU 写入 BSP 读出。
2.1.3 接收缓冲器 (RXB RXFIFO)
接收缓冲器是验收滤波器和 CPU 之间的接口 用来储存从 CAN 总线上接收和接收的信息 接收缓冲器 RXB 13 个字节 作为接收 FIFO RXFIFO 长 64 字节 的一个窗口 可被 CPU 访问。CPU 在此 FIFO 的支持下 可以在处理信息的时候接收其它信息
2.1.4 验收滤波器 (ACF)
验收滤波器把它其中的数据和接收的识别码的内容相比较 以决定是否接收信息 在纯粹的接收测试中所有的信息都保存在 RXFIFO 中。
2.1.5 位流处理器 (BSP)
位流处理器是一个在发送缓冲器 RXFIFO 和 CAN 总线之间控制数据流的程序装置 它还在 CAN 总线上执行错误检测 仲裁 填充和错误处理。
2.1.6 位时序逻辑( BTL)
位时序逻辑监视串口的 CAN 总线和处理与总线有关的位时序 它在信息开头 弱势-支配 的总线传输时同步 CAN 总线位流 硬同步 接收信息时再次同步下一次传送 软同步 BTL 还提供了可编程的时间段来补偿传播延迟时间 相位转换 例如 由于振荡漂移和定义采样点和一位时间内的采样次数。
2.1.7 错误管理逻辑 (EML)
EML 负责传送层模块的错误管制 它接收 BSP 的出错报告 通知 BSP 和 IML 进行错误统计。
2.2	Sja1000与M2的接线图
M2作为主控芯片通过与sja1000的接口引脚的硬件连接来控制sja1000的运行。sja1000与can收发器TJA连接，将位时序逻辑产生的信号通过TJA转化成高低can信号can H和can L，与can的物理总线连接。而如今市面上大多数的sja1000都是同TJA集成好的，我们只需要完成mcu与sja1000的接线即可。
sja1000与mcu相关的管脚排列如下表所示:





表1 管脚排列
Table 1 Title of Table
符号	引脚	说明
AD7-AD0	2,1,28-23	多路地址/数据总线
ALE/AS	3	ALE输入信号 Intel模式 AS输入信号 Motorola模式
/CS	4	片选输入 低电平允许访问SJA1000
(/RD)/E	5	微控制器的/RD信号 Intel模式或E使能信号 Motorola模式
/WR	6	微控制器的/WR信号(Intel模式) 或RD/ (/WR) 信号 (Motorola模式)
/INT	16	中断输出 用于中断微控制器 /INT在内部中断寄存器各位都被置位时低电平有效 /INT是开漏输出 且与系统中的其它/INT是
线或的 此引脚上的低电平可以把IC从睡眠模式中激活
VDD1	22	逻辑电路的5V电压源
VSS1	8	接地

Sja1000使用8位地址数据总线复用，这就要求mcu的8个io口与sja1000的AD7-AD0实现双向的数据交换，我们选择使用M2的io0-io7以及P_A0N,P_A0P(注意在使用io口时关闭某些io口的复用功能)。
Mcu完成对sja1000中寄存器的读写主要在于控制sja的四个引脚时序关系。这四个引脚分别为数据锁存ALE,片选信号CS，和读写触发控制引脚WR和RD引脚。这里可以使用M2的四个输出引脚完成时序配置功能。同时在sja1000产生中断的时候需要mcu对中断做出反应，这里使用一个输入引脚接sja1000的中断int信号，同时M2需要一个输入引脚接受外部中断按键key信号。下表显示M2与sja1000的接线情况。








表2  M2与sja1000的接线
Table 1 Title of Table
Sja1000	M2
AD7-AD0	INT0-INT5 
ALE/AS	SEG20
/CS	SEG21
(/RD)/E	SEG22
/WR	SEG23
RST	SEG24
/INT	SEG18
KEY	SEG19
VDD1	VDD
VSS1	GND



2.3	Sja1000读写周期时序图 
为了满足对sja1000寄存器的控制，必须使特定接口的输出满足时序的要求，如下图为sja1000的控制读时序图：
 
写时序图：

 
我们选择intel模式，在此模式下时序图的配置必须要满足一些基本的时间要求，以读为例，具体的时间要求如下表所示：
表3 时序要求
Table 1 Title of Table
符号	参数	最大值	最小值	单位
tsu(A-AL)	对ALE低电平的地址的建立时间	8	-	ns
th(AL-A)	ALE为底的保持时间	2	-	ns
tW(AL)	ALE的脉冲宽度	8	-	ns
tLLRL	ALE低到/RD低	10	-	ns
tRLQV	/RD低，输出有效数据	-	50	ns
tCLRL	/CS低到/RD低	0	-	ns
tW(R)	/RD脉冲宽度	40	-	ns
tRHCH	/RD高到/CS高	0	-	ns
tRHDZ	/RD为高数据悬空	-	30	ns

	根据时序图，完成对MCU的4个output口的配置，配置关键代码如下图所示
  最后将读写时序封装成两条指令RD_SJA_REG(ADDRESS) 和 WR_SJA_REG(ADDRESS, DATA)并将其封装在头文件SJA1000RW.h中，方便后续调用。

3.测试sja1000
完成对sja1000的时序配置之后就可以对sja1000的寄存器进行读写配置。为了验证M2对sja1000寄存器的读写是否正确我们可以通过sja在复位模式下的特征值来进行判断。
我们通过给Sja1000的rst引脚输入低电平可以使sja1000硬件复位，sja在硬件复位模式下的一些特征值如下表所示：
表4 sja1000复位模式某些寄存器值
Table 1 Title of Table
寄存器	地址	硬件复位值
模式	Can地址‘0’	0x01
命令	Can地址‘1’	0x00
状态	Can地址‘2’	0x3C
中断	Can地址‘3’	0x00
错误报警限制	Can地址‘13’	0x60
RX错误计数器	Can地址‘14’	0x00
TX错误计数器	Can地址‘15’	0x00
测试	Can地址‘9’	0xAA
一个简单的扫取地址的小程序我们就可以得到下图8个寄存器的的数据

数据完全吻合证明对sja1000的寄存器读取配置成功。


4. 对sja1000初始化寄存器配置
在完成sja1000读写can报文信号之前需要对sja1000的寄存器完成一些基本配置使的sja1000实现特定功能。Sja1000的寄存器对于mcu来说作为外部寄存器使用，为了避免与mcu片内寄存器地址产生干扰，
在配置sja1000的寄存器之前可以是给sja1000的寄存器设置一个基地址，128个寄存器的地址是基于此基地址进行分配的，这样在不同的mcu控制下只需要改变基地址就可以了，方便程序的移植。
	Sja1000的寄存器配置初始化如下图：
 
4.1 Sja1000的模式寄存器配置
模式寄存器的内容是用来改变CAN控制器的行为的。通过设置此位可以达到模式切换，在进行寄存器配置时首先第一步就是要进入复位模式。下表提供了模式寄存器一些必要的功能对应的位置。其余位均设置成‘0’即可。
表3 模式寄存器各位功能：CAN地址‘0’
Table 1 Title of Table
位	符号	名称	值	
MOD.3	

AFM	

验收滤波器模式	
1	单；选择单个验收滤波器（32位长度）
			0	双；选择两个验收滤波器（每个有16位激活）
MOD.0	


RM	


复位模式	
1	复位；检测到复位模式位被置位，中止当前正字接受/发送的信息，进入复位模式
			0	正常；复位模式位接受到‘1-0’的跳变后，CAN控制器回到工作模式

4.2  Sja1000的单滤波器配置
验收滤波器所实现的功能是，只有当接受到符合验收规定的数据时才会验收通过，并接受至接受缓冲区中。验收滤波器由验收代码寄存器（ACRn）和验收屏蔽寄存器(AMRn)组成。其中验收代码寄存器用来设置可以通过的ID号，验收屏蔽寄存器用来给验收代码寄存器使能。其对应的逻辑关系如下图所示。
 


4.3  Sja1000的通信波特率配置
进行can通信时如果通信速度过慢会影响数据传送的实时性，如果通信过快则会有丢包等不稳定现象产生。因此在不同的工况下需要对can通信速率进行配置，找到最合适的通信波特率。Sja1000对通信波特率进行配置的寄存器是第6号总线定时寄存器，寄存器各位如下表所示：
表3 总线定时寄存器0（BRT0）的位功能说明：CAN地址‘6’
Table 1 Title of Table
BIT 7	BIT 6	BIT 5	BIT 4	BIT 3	BIT 2	BIT 1	BIT 0
SJW.1	SJW.0	BRP.5	BRP.4	BRP.3	BRP.2	BRP.1	BRP.0
CAN系统时钟由如下公式计算
Tscl=2tclk*(32*BRP.5+16*BRP.4+8*BRP.3+4*BRP.2+2*BRP.1+BRP.0+1)
这里tclk=xtal的频率周期=1/Fxtal



4.4  Sja1000的初始化主程序



5. 读写can信息
5.1  相关寄存器配置
Can通信的优点之一就在于其通信的稳定性，也因此can被应用在对稳定性要求较高的场合。现实中通过sja1000读写can信号时可能会出现数据传输错误或者数据溢出等复杂的情况，如何判断can通信哪里出问题并提供解决方案是保证can稳定通信的前提之一。Sja1000里面与can通信状态相关的寄存器有3个，分别为状态寄存器，中断寄存器和中断使能寄存器。
这三个寄存器的功能分别在下面3个表格里进行阐述：
表3 状态寄存器各位功能：CAN地址‘2’
Table 1 Title of Table
位	符号	名称	值	功能
SR.7	

BS	

总线状态	
1	总线关闭；CAN控制器不参与总线活动
			
0	总线开启；CAN控制器参与总线活动
SR.6	

ES	

出错状态	
1	出错；至少一个错误计数器满或超过了由错误报警限制寄存器（EWLR）定义的CPU报警限制
			0	正常；发送和接受错误计数器都在报警阈值以下
SR.5	
TS	
发送状态	
1	发送；CAN控制器正在发送信息
			0	空闲
SR.4	
RS	
接受状态	
1	接受；CAN控制器正在接受信息
			0	空闲
SR.3	

TCS	

出错状态	
1	完毕；最后一次发送已被成功处理
			0	未完；当前请求的发送未处理完
SR.2	

TBS	

发送缓冲器状态	
1	释放；CPU可以向发送缓冲器中写信息
			0	锁定；CPU不能访问发送缓冲器；信息不是在等待发送也不是正在发送。
SR.1	

DOS	

数据溢出状态	
1	溢出;信息因RXFIFO中无足够的存储空间而丢失
			0	空缺;自从上一次执行清除数据溢出命令以来无数据溢出发生
SR.0	

RBS	

接受缓冲区状态	
1	满;RXFIFO中有可用信息
			0	空;无可用信息


表4 中断寄存器各位功能：CAN地址‘3’
Table 1 Title of Table
位	符号	名称	值	功能
IR.7	

BEI	

总线错误中断	
1	置位;当CAN控制器检测到总线错误且中断使能寄存器中的BEIE被置位时此位被置位
			0	复位
IR.6	

ALL	

仲裁丢失中断	
1	置位;当CAN控制器丢失仲裁,变为接收器和中断使能寄存器的ALIE为被置位时,此位被置位
			0	复位
IR.5	
EPI	
错误消极中断	
1	置位;当CAN控制器到达错误消极状态(至少一个错误计数器超过协议规定的值127)或从错误消极状态又进入错误活动状态以及中断寄存器的EPIE位被置位时此位被置1
			0	复位
IR.4	
WUI	
唤醒中断	
1	置位;当CAN控制器在睡眠模式中检测到总线的活动且中断寄存器的WUIE位被置1时此位被置位
			0	复位
IR.3	

DOI	
数据溢出中断	
1	置位;数据溢出状态位有 0-1 跳变且中断寄存器的DOIE位被置位时此位被置1
			0	复位
IR.2	

EI	

错误报警中断	
1	置位;错误状态位和总线状态位的改变和中断寄存器的EIE位被置位时此位被置1
			0	复位
IR.1	

TI	

发送中断	
1	置位;发送缓冲器状态从’0-1’(释放)跳变且中断寄存器的TIE位被置位时此位被置1
			0	复位
IR.0	

RI	

接受中断	
1	置位;接收FIFO不空且中断寄存器的RIE位被置位时此位被置1
			0	复位;RXFIFO无可用信息

表5 中断使能寄存器各位功能：CAN地址‘4’
Table 1 Title of Table
位	符号	名称	值	功能
IER.7	

BEIE	

总线错误中断使能	
1	使能;如果检测到总线错误,则CAN控制器请求相应的中断
			0	禁能
IER.6	

ALLE	

仲裁丢失中断使能使能使能	
1	使能;如果CAN控制器已丢失了仲裁,则请求相应的中断
			0	禁能
IER.5	
EPIE	
错误消极中断使能	
1	使能;若CAN控制器的错误状态改变(从消极到活动或反之), 则请求相应的中断
			0	禁能
IER.4	
WUIE	
唤醒中断使能	
1	使能;如果睡眠模式中的CAN控制器被唤醒,则请求相应的中断
			0	禁能
IER.3	

DOIE	
数据溢出中断使能	
1	使能;如果数据溢出状态位被置位(见状态寄存器;表3),CAN控制器请求相应的中断
			0	禁能
IER.2	

EIE	

错误报警中断使能	
1	使能;如果错误或总线状态改变(见状态寄存器;表14),CAN控制器请求相应的中断
			0	禁能
IER.1	

TIE	

发送中断使能	
1	使能;当信息被成功发送或发送缓冲器又可访问(例如,中止发送命令后)时,CAN控制器请求相应的中断
			0	禁能
IER.0	

RIE	

接受中断使能	
1	使能;当接收缓冲器状态是’满’时,CAN控制器请求相应的中断
			0	禁能


5.1  CAN报文的协议

